<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Radio PWA ‚Äì Retro Dark (v2)</title>
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <style>
    :root{
      --bg:#000;
      --panel:#101317;
      --text:#dffcff;
      --cyan:#00ffff;
      --cyan-soft:#67e8f9;
      --border:rgba(103,232,249,.35);
      --dial-w: min(92vw, 420px);
      --dial-inner: calc(var(--dial-w) - 40px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:flex;align-items:flex-start;justify-content:center;padding:16px}
    .shell{width:min(520px,100%);background:var(--panel);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden}
    .top{background:#000;color:var(--cyan);padding:16px 16px 8px}
    .clock{font-size:clamp(36px,14vw,56px);font-weight:900;line-height:1;margin:.25rem 0}
    .slogan{opacity:.8;font-size:13px;margin-bottom:6px}
    .dial-wrap{padding:10px 16px}
    .dial{position:relative;height:4px;background:#3b3f47;border-radius:999px;margin:0 auto;width:var(--dial-inner)}
    .tick{position:absolute;top:50%;transform:translate(-50%,-140%);font-size:11px;color:var(--cyan-soft);font-weight:700;white-space:nowrap}
    .needle{position:absolute;top:50%;transform:translate(-50%,-140%);width:4px;height:64px;background:var(--cyan);border-radius:2px;box-shadow:0 0 16px var(--cyan)}
    .panel{padding:0 16px 10px}
    .wave-card{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#050505}
    .wave-head{display:flex;justify-content:space-between;align-items:center;color:var(--cyan-soft);font-size:12px;padding:8px 10px}
    .wave{height:160px;position:relative;background:#000}
    .wave::before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,255,200,.12),rgba(0,255,255,.28),rgba(0,255,200,.12));filter:blur(12px);pointer-events:none}
    .buttons{padding:12px 16px 16px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{border:1px solid var(--border);background:transparent;color:var(--cyan-soft);border-radius:12px;padding:12px;font-weight:800;text-align:center;cursor:pointer}
    .btn.active{background:#0891b2;color:white;border-color:#22d3ee}
    .actions{grid-column:1/3;display:flex;gap:8px}
    .btn-ghost{flex:1}
    .hint{color:#9fb6c2;font-size:12px;text-align:center;padding:0 12px 14px}

    @media (max-width:380px){
      .buttons{grid-template-columns:1fr; gap:10px}
      .needle{height:56px}
      .wave{height:140px}
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="top">
      <div class="clock" id="clock">00:00</div>
      <div class="slogan">Good luck every day</div>
    </div>

    <!-- Linear dial (pre-rendered ticks + needle) -->
    <div class="dial-wrap">
      <div class="dial" id="dial">
        <div class="tick" data-idx="0">97.9</div><div class="tick" data-idx="1">100.7</div><div class="tick" data-idx="2">102.3</div><div class="tick" data-idx="3">104.9</div>
        <div class="needle" id="needle" style="left:0%"></div>
      </div>
    </div>

    <!-- Waveform -->
    <div class="panel">
      <div class="wave-card">
        <div class="wave-head">
          <span>Signal</span>
          <span id="sigName">‚Äî</span>
        </div>
        <div class="wave"><canvas id="wave"></canvas></div>
      </div>
    </div>

    <!-- Flat station buttons (pre-rendered) -->
    <div class="buttons" id="buttons">
      <button class="btn" data-i="0" data-action="play">Now 97.9</button><button class="btn" data-i="1" data-action="play">Blue 100.7</button><button class="btn" data-i="2" data-action="play">Aspen 102.3</button><button class="btn" data-i="3" data-action="play">LN+ 104.9</button>
      <div class="actions">
        <button class="btn btn-ghost" data-action="stop">‚èπÔ∏é Stop</button>
        <button class="btn btn-ghost" data-action="mute">üîá Mute</button>
      </div>
    </div>
    <div class="hint">Tip: si no suena, toc√° Play una vez (pol√≠tica del navegador).</div>
  </div>

  <audio id="player" preload="none" crossorigin="anonymous"></audio>

  <script>
    const stations = [["Now 97.9", "https://ipanel.instream.audio:7002/stream"], ["Blue 100.7", "https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac"], ["Aspen 102.3", "https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3"], ["LN+ 104.9", "https://stream.radio.co/s2ed3bec0a/listen"]];
    const $player = document.getElementById('player');
    const $buttons = document.getElementById('buttons');
    const $wave = document.getElementById('wave');
    const $sigName = document.getElementById('sigName');
    const $needle = document.getElementById('needle');
    const $ticks = [...document.querySelectorAll('.tick')];

    let current = null, level = 0, wobble = 0;

    function layoutTicks(){
      const n = stations.length - 1;
      $ticks.forEach(t => {
        const i = +t.dataset.idx;
        t.style.left = (i/n*100) + '%';
      });
      moveNeedleTo(current ?? 0, 0);
    }
    addEventListener('resize', layoutTicks);

    $buttons.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-action]'); if(!el) return;
      const act = el.dataset.action;
      if(act==='play'){ useStation(+el.dataset.i); }
      if(act==='stop'){ stop(); }
      if(act==='mute'){ $player.muted = !$player.muted; }
    });

    function updateActive(){
      [...document.querySelectorAll('.btn[data-action="play"]')].forEach((b,idx)=>{
        b.classList.toggle('active', current===idx && !$player.paused);
      });
    }

    function useStation(i){
      const s = stations[i];
      if(!s) return;
      if(current!==i){ $player.src = s[1]; current = i; }
      $sigName.textContent = s[0];
      if('mediaSession' in navigator){
        navigator.mediaSession.metadata = new MediaMetadata({ title: s[0], artist: 'Radio en vivo', album: 'Online' });
      }
      $player.play().catch(()=>{});
      updateActive();
      moveNeedleTo(i);
      localStorage.setItem('lastStation', i);
    }

    function stop(){ $player.pause(); updateActive(); }
    function moveNeedleTo(i, extraPx=0){
      const steps = stations.length - 1;
      const base = (i/steps*100);
      $needle.style.left = `calc(${base}% + ${extraPx}px)`;
    }

    function tickClock(){ const d=new Date(); document.getElementById('clock').textContent = String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
    setInterval(tickClock, 1000); tickClock();

    (function setupAudio(){
      let ctx=null, src=null, an=null, raf=0;
      const c = $wave.getContext('2d');
      function draw(){
        const w = $wave.width = $wave.clientWidth * devicePixelRatio;
        const h = $wave.height = $wave.clientHeight * devicePixelRatio;
        c.clearRect(0,0,w,h);
        let rms=0.1, path=[];
        if(an){
          const arr = new Uint8Array(an.frequencyBinCount);
          an.getByteTimeDomainData(arr);
          let sum=0, step=Math.max(1, Math.floor(arr.length/w));
          for(let x=0;x<w;x++){ const v=(arr[x*step]-128)/128; sum+=v*v; path.push(v); }
          rms=Math.sqrt(sum/arr.length);
        }else{ for(let x=0;x<w;x++) path.push(Math.sin((x/w)*Math.PI*2*2 + performance.now()/500)); }
        const tgt = Math.min(1, rms*3);
        level = level*0.8 + tgt*0.2;
        wobble = wobble*0.85 + ((Math.random()*2-1)*tgt)*0.15;

        c.lineWidth = 3*devicePixelRatio; c.strokeStyle = '#00ffff'; c.shadowBlur=22; c.shadowColor='#00ffff';
        c.beginPath();
        for(let x=0;x<w;x++){ const y = h/2 + path[x]*(h*0.35)*Math.max(0.25, tgt+0.1); if(x===0) c.moveTo(x,y); else c.lineTo(x,y); }
        c.stroke();

        if(current!=null){ moveNeedleTo(current, wobble*6); }
        raf=requestAnimationFrame(draw);
      }
      function boot(){
        try{ ctx = new (window.AudioContext || window.webkitAudioContext)(); if(ctx.state==='suspended') ctx.resume(); src = ctx.createMediaElementSource($player); an = ctx.createAnalyser(); an.fftSize=2048; src.connect(an); an.connect(ctx.destination); }catch(e){}
        draw();
      }
      boot();
      addEventListener('beforeunload', ()=> cancelAnimationFrame(raf));
    })();

    document.addEventListener('DOMContentLoaded', ()=>{ layoutTicks(); updateActive(); });
    layoutTicks(); updateActive();

    const last = +localStorage.getItem('lastStation');
    if(Number.isInteger(last)){ current=last; $player.src = stations[last][1]; $sigName.textContent = stations[last][0]; moveNeedleTo(last); }
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js')); }
  </script>
</body>
</html>

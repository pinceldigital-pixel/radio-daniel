<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radio PWA ‚Äì Retro Dark</title>
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <style>
    :root{
      --bg:#000;
      --panel:#111;
      --panel-2:#0b0b0b;
      --text:#eafcff;
      --muted:#7dd3fc;
      --cyan:#0ff;
      --accent:#22d3ee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:flex;align-items:center;justify-content:center}
    .shell{width:min(420px,95vw);background:#121212;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden}
    .top{background:#000;color:var(--cyan);padding:16px}
    .date{opacity:.8;font-size:12px;text-transform:capitalize}
    .clock{font-size:48px;font-weight:900;line-height:1;margin:.25rem 0}
    .slogan{opacity:.8;font-size:12px}
    .dial-wrap{padding:16px}
    .dial{position:relative;height:4px;background:#4b5563;border-radius:999px;margin:0 auto;width:260px}
    .tick{position:absolute;top:50%;transform:translate(-50%,-140%);font-size:10px;color:#67e8f9;font-weight:700;white-space:nowrap}
    .needle{position:absolute;top:50%;transform:translate(-50%,-140%);width:4px;height:56px;background:#22d3ee;border-radius:2px;box-shadow:0 0 16px #0ff}
    .panel{padding:0 16px 10px}
    .wave-card{border:1px solid rgba(34,211,238,.35);border-radius:14px;overflow:hidden;background:#050505}
    .wave-head{display:flex;justify-content:space-between;align-items:center;color:#67e8f9;font-size:11px;padding:8px 10px}
    .wave{height:110px;position:relative;background:#000}
    /* Neon light glow behind the waveform */
    .wave::before{
      content:"";position:absolute;inset:0;
      background:linear-gradient(90deg,rgba(0,255,200,.12),rgba(0,255,255,.28),rgba(0,255,200,.12));
      filter:blur(12px);
      pointer-events:none;
    }
    .buttons{padding:12px 16px 16px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{border:1px solid rgba(34,211,238,.35);background:transparent;color:#67e8f9;border-radius:12px;padding:12px;font-weight:800;text-align:center;cursor:pointer}
    .btn.active{background:#0891b2;color:white;border-color:#22d3ee}
    .actions{grid-column:1/3;display:flex;gap:8px}
    .btn-ghost{flex:1}
    .hint{color:#94a3b8;font-size:12px;text-align:center;padding:6px 12px 14px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="top">
      <div class="date" id="date"></div>
      <div class="clock" id="clock">00:00</div>
      <div class="slogan">Good luck every day</div>
    </div>

    <!-- Linear dial -->
    <div class="dial-wrap">
      <div class="dial" id="dial">
        <!-- ticks injected -->
        <div class="needle" id="needle" style="left:0%"></div>
      </div>
    </div>

    <!-- Waveform -->
    <div class="panel">
      <div class="wave-card">
        <div class="wave-head">
          <span>Signal</span>
          <span id="sigName">‚Äî</span>
        </div>
        <div class="wave"><canvas id="wave"></canvas></div>
      </div>
    </div>

    <!-- Flat station buttons (names only) -->
    <div class="buttons" id="buttons"></div>
    <div class="hint">Tip: si no suena, toc√° Play una vez (pol√≠tica del navegador).</div>
  </div>

  <audio id="player" preload="none" crossorigin="anonymous"></audio>

  <script>
    const stations = [
      { name: "Now 97.9", url: "https://ipanel.instream.audio:7002/stream" },
      { name: "Blue 100.7", url: "https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac" },
      { name: "Aspen 102.3", url: "https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3" },
      { name: "LN+ 104.9", url: "https://stream.radio.co/s2ed3bec0a/listen" },
    ];

    const $player = document.getElementById('player');
    const $buttons = document.getElementById('buttons');
    const $wave = document.getElementById('wave');
    const $sigName = document.getElementById('sigName');
    const $needle = document.getElementById('needle');
    const $dial = document.getElementById('dial');

    let current = null;
    let level = 0; // 0..1
    let needleWobble = 0; // -1..1

    // Render buttons (no icons, names only)
    function renderButtons(){
      $buttons.innerHTML = stations.map((s,i)=>\`
        <button class="btn" data-i="\${i}" data-action="play">\${s.name}</button>
      \`).join('') + \`
        <div class="actions">
          <button class="btn btn-ghost" data-action="stop">‚èπÔ∏é Stop</button>
          <button class="btn btn-ghost" data-action="mute">üîá Mute</button>
        </div>\`;
      updateActive();
    }
    function updateActive(){
      [...$buttons.querySelectorAll('.btn[data-action="play"]')].forEach((b,idx)=>{
        b.classList.toggle('active', current===idx && !$player.paused);
      });
    }

    // Linear dial ticks
    function renderTicks(){
      const tickWrap = $dial;
      const w = stations.length - 1;
      stations.forEach((s,i)=>{
        const tick = document.createElement('div');
        tick.className = 'tick';
        tick.style.left = (i/w*100) + '%';
        tick.textContent = (s.name.split(' ')[1] || s.name);
        tickWrap.appendChild(tick);
      });
    }

    function useStation(i){
      const s = stations[i];
      if(!s) return;
      if(current!==i){ $player.src = s.url; current = i; }
      $sigName.textContent = s.name;
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({ title: s.name, artist: 'Radio en vivo', album: 'Online' });
      }
      $player.play().catch(()=>{});
      updateActive();
      moveNeedleTo(i);
      localStorage.setItem('lastStation', i);
    }

    function moveNeedleTo(i){
      const w = stations.length - 1;
      const base = (i/w*100);
      // animate with wobble from audio level
      $needle.style.left = base + '%';
    }

    function stop(){ $player.pause(); updateActive(); }
    function toggleMute(){ $player.muted = !$player.muted; }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action]');
      if(!btn) return;
      const action = btn.getAttribute('data-action');
      if(action==='play'){ useStation(+btn.dataset.i); }
      if(action==='stop'){ stop(); }
      if(action==='mute'){ toggleMute(); }
    });

    // Time display
    function tickClock(){
      const d = new Date();
      const dateOpts = { weekday:'long', month:'long', day:'numeric' };
      document.getElementById('date').textContent = d.toLocaleDateString(undefined, dateOpts);
      document.getElementById('clock').textContent = 
        String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }
    setInterval(tickClock, 1000); tickClock();

    // Waveform + WebAudio
    (function setupAudio(){
      let ctx=null, src=null, analyser=null, raf=0;
      const canvas = $wave;
      const c = canvas.getContext('2d');

      function draw(){
        const w = canvas.width = canvas.clientWidth * devicePixelRatio;
        const h = canvas.height = canvas.clientHeight * devicePixelRatio;
        c.clearRect(0,0,w,h);

        let rms = 0.12;
        const path = [];
        if(analyser){
          const arr = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteTimeDomainData(arr);
          let sum = 0;
          const step = Math.max(1, Math.floor(arr.length / w));
          for(let x=0;x<w;x++){
            const v = (arr[x*step]-128)/128;
            sum += v*v; path.push(v);
          }
          rms = Math.sqrt(sum/arr.length);
        }else{
          for(let x=0;x<w;x++) path.push(Math.sin((x/w)*Math.PI*2*2 + performance.now()/500));
        }

        const target = Math.min(1, rms*3);
        level = level*0.8 + target*0.2;
        needleWobble = needleWobble*0.85 + ( (Math.random()*2-1)*target )*0.15;

        // cyan glow waveform
        c.lineWidth = 3 * devicePixelRatio;
        c.strokeStyle = '#00ffff';
        c.shadowBlur = 22; c.shadowColor = '#00ffff';
        c.beginPath();
        for(let x=0;x<w;x++){
          const y = h/2 + path[x]*(h*0.35)*Math.max(0.25, target+0.1);
          if(x===0) c.moveTo(x,y); else c.lineTo(x,y);
        }
        c.stroke();

        // subtle needle wobble
        if(current!=null){
          const wSteps = stations.length-1;
          const base = (current/wSteps*100);
          const wobblePx = needleWobble*6;
          $needle.style.left = `calc(${base}% + ${wobblePx}px)`;
        }

        raf = requestAnimationFrame(draw);
      }

      function boot(){
        try{
          ctx = new (window.AudioContext || window.webkitAudioContext)();
          if(ctx.state === 'suspended') ctx.resume();
          src = ctx.createMediaElementSource($player);
          analyser = ctx.createAnalyser();
          analyser.fftSize = 2048;
          src.connect(analyser);
          analyser.connect(ctx.destination);
        }catch(e){}
        draw();
      }
      boot();
      window.addEventListener('beforeunload', ()=> cancelAnimationFrame(raf));
    })();

    // Restore last
    (function restore(){
      renderButtons(); renderTicks();
      const last = +localStorage.getItem('lastStation');
      if(Number.isInteger(last)){ current = last; moveNeedleTo(last); $sigName.textContent = stations[last].name; $player.src = stations[last].url; }
    })();

    // PWA SW
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js'));
    }
  </script>
</body>
</html>

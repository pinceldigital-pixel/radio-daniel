<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Radio FM</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Orbitron & Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">

    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RadioFM">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <style>
        /* SIN CAMBIAR DISEÑO */
        body { font-family: 'Inter', sans-serif; font-weight: 400; }
        .font-digital { font-family: 'Orbitron', sans-serif; }
        h1, h2, .font-bold { font-family: 'Inter', sans-serif; font-weight: 700; }
        input[type=range]{ -webkit-appearance:none; appearance:none; width:100%; background:transparent; cursor:pointer; }
        input[type=range]::-webkit-slider-runnable-track{ height:6px; background:linear-gradient(to right,#374151,#4b5563,#374151); border-radius:3px; border:1px solid #1f2937; }
        input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; margin-top:-7px; width:20px; height:20px; background:#d1d5db; border-radius:50%; border:2px solid #9ca3af; box-shadow:0 0 2px rgba(0,0,0,0.5); }
        input[type=range]::-moz-range-track{ height:6px; background:linear-gradient(to right,#374151,#4b5563,#374151); border-radius:3px; }
        input[type=range]::-moz-range-thumb{ width:20px; height:20px; background:#d1d5db; border-radius:50%; border:2px solid #9ca3af; box-shadow:0 0 2px rgba(0,0,0,0.5); }
        .is-playing #display { filter: brightness(1.1); }
        .is-off #radio-body { opacity: 0.6; pointer-events: none; }
        .is-off #display { background: #374151 !important; }
        .is-off #station-name, .is-off #frequency-display { color: transparent; }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <div id="radio-container" class="bg-zinc-800 text-white w-full max-w-sm mx-auto rounded-2xl shadow-2xl overflow-hidden border-2 border-zinc-700 transition-all duration-500">
        
        <header class="flex justify-between items-center p-4 bg-zinc-900/70">
            <h1 id="title-install" class="text-xl font-bold tracking-wider select-none">FM RADIO</h1>
            <button id="power-button" class="w-8 h-8 flex items-center justify-center rounded-full bg-red-600 hover:bg-red-500 active:bg-red-700 shadow-lg transition-colors" aria-label="Encendido">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1012.728 0M12 3v9" />
                </svg>
            </button>
        </header>

        <main id="radio-body" class="p-4 space-y-4 transition-opacity duration-500">
            <div id="display" class="rounded-lg p-6 text-center shadow-inner relative overflow-hidden transition-all duration-500">
                <canvas id="visualizer" class="absolute top-0 left-0 w-full h-full opacity-60"></canvas>
                <div class="relative z-10">
                    <h2 id="station-name" class="text-3xl font-bold h-9 transition-all duration-300">---</h2>
                    <div class="my-2">
                        <p id="frequency-display" class="text-7xl font-digital font-bold tracking-widest">97.9</p>
                        <span id="mhz-text" class="text-xl font-digital">MHz</span>
                    </div>
                </div>
            </div>

            <div class="bg-zinc-700/50 p-4 rounded-lg shadow-md space-y-2">
                <div class="flex items-center justify-between space-x-4">
                    <button id="scan-down" class="p-2 bg-zinc-800 rounded-md hover:bg-zinc-600 transition-colors" aria-label="Anterior">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <div class="w-full relative">
                         <div class="flex justify-between text-zinc-400 px-1 text-sm">
                            <span>97</span><span>101</span><span>105</span>
                        </div>
                        <input id="frequency-slider" type="range" min="97.0" max="105.0" step="0.1" value="97.9">
                        <div class="w-full h-2 absolute top-[20px] left-0 pointer-events-none">
                             <div class="w-0.5 h-full bg-zinc-500 mx-auto"></div>
                        </div>
                    </div>
                    <button id="scan-up" class="p-2 bg-zinc-800 rounded-md hover:bg-zinc-600 transition-colors" aria-label="Siguiente">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
                 <div class="relative h-2">
                     <div id="slider-pointer" class="absolute top-0 w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-t-8 transform -translate-x-1/2 transition-all duration-100 ease-linear"></div>
                </div>
            </div>

            <div id="controls" class="flex items-center justify-center space-x-6 bg-zinc-900/50 rounded-full p-2">
                <button id="btn-prev" class="p-3 rounded-full" aria-label="Atrás">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
                </button>
                <button id="play-pause-button" class="w-16 h-16 rounded-full bg-zinc-800 flex items-center justify-center shadow-lg" aria-label="Reproducir/Pausar">
                    <div id="play-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg></div>
                    <div id="pause-icon" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg></div>
                </button>
                <button id="btn-next" class="p-3 rounded-full" aria-label="Adelante">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                </button>
            </div>
        </main>
    </div>

    <audio id="audio-player" preload="none" crossorigin="anonymous"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                isOn: true,
                isPlaying: false,
                currentFrequency: 97.9,
                stations: [
                    { name: 'Now',  freq: 97.9, url: 'https://ipanel.instream.audio:7002/stream', mime: 'audio/mpeg', theme: {
                        bg: 'bg-gradient-to-b from-sky-500 to-sky-700', text: 'text-sky-200', glow: 'cyan-glow', pointer: 'border-t-sky-400', stroke: 'rgba(200, 240, 255, 0.7)'
                    }},
                    { name: 'Blue FM', freq: 100.7, url: 'https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac', mime: 'audio/aac', theme: {
                        bg: 'bg-gradient-to-b from-blue-500 to-blue-700', text: 'text-blue-200', glow: 'blue-glow', pointer: 'border-t-blue-400', stroke: 'rgba(200, 220, 255, 0.7)'
                    }},
                    { name: 'Aspen', freq: 102.3, url: 'https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3', mime: 'audio/mpeg', theme: {
                        bg: 'bg-gradient-to-b from-emerald-500 to-emerald-700', text: 'text-emerald-200', glow: 'green-glow', pointer: 'border-t-emerald-400', stroke: 'rgba(200, 255, 220, 0.7)'
                    }},
                    { name: 'LN+', freq: 104.9, url: 'https://stream.radio.co/s2ed3bec0a/listen', mime: 'audio/mpeg', theme: {
                        bg: 'bg-gradient-to-b from-red-500 to-red-700', text: 'text-red-200', glow: 'red-glow', pointer: 'border-t-red-400', stroke: 'rgba(255, 200, 200, 0.7)'
                    }}
                ],
                deferredPrompt: null
            };

            const radioContainer = document.getElementById('radio-container');
            const powerButton = document.getElementById('power-button');
            const playPauseButton = document.getElementById('play-pause-button');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const frequencySlider = document.getElementById('frequency-slider');
            const sliderPointer = document.getElementById('slider-pointer');
            const frequencyDisplay = document.getElementById('frequency-display');
            const stationNameDisplay = document.getElementById('station-name');
            const audioPlayer = document.getElementById('audio-player');
            const displayDiv = document.getElementById('display');
            const mhzText = document.getElementById('mhz-text');
            const controls = document.getElementById('controls');
            const visualizerCanvas = document.getElementById('visualizer');
            const canvasCtx = visualizerCanvas.getContext('2d');
            const titleInstall = document.getElementById('title-install');

            let audioContext, analyser, source, dataArray, isAudioContextInitialized = false;

            function setupCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = displayDiv.getBoundingClientRect();
                visualizerCanvas.width = rect.width * dpr;
                visualizerCanvas.height = rect.height * dpr;
                canvasCtx.setTransform(1,0,0,1,0,0);
                canvasCtx.scale(dpr, dpr);
            }

            function canPlay(mime){ return !!audioPlayer.canPlayType && audioPlayer.canPlayType(mime) !== ''; }

            function initAudioContextSafe() {
                if (isAudioContextInitialized) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    source = audioContext.createMediaElementSource(audioPlayer);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                    analyser.fftSize = 256;
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    isAudioContextInitialized = true;
                    drawVisualizer();
                } catch (e) {
                    console.warn('Visualizer desactivado (posible CORS del stream).', e);
                    isAudioContextInitialized = false;
                }
            }

            function drawVisualizer() {
                requestAnimationFrame(drawVisualizer);
                if (!isAudioContextInitialized) return;
                analyser.getByteFrequencyData(dataArray);
                canvasCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                const barWidth = (visualizerCanvas.width / (analyser.frequencyBinCount * 2));
                let x = 0;
                const station = getCurrentStation();
                const strokeStyle = station ? station.theme.stroke : 'rgba(240, 255, 255, 0.7)';
                canvasCtx.fillStyle = strokeStyle;
                for (let i = 0; i < analyser.frequencyBinCount; i++) {
                    const barHeight = (dataArray[i] / 255) * visualizerCanvas.height * 0.8;
                    canvasCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 2;
                }
            }

            const removeAllThemes = () => {
                const themes = ['cyan', 'blue', 'green', 'red'];
                const elementsToClean = [displayDiv, mhzText, sliderPointer, playPauseButton, ...controls.querySelectorAll('button')];
                elementsToClean.forEach(el => {
                    themes.forEach(theme => {
                        el.classList.remove(`from-${theme}-500`, `to-${theme}-700`, `text-${theme}-200`, `text-${theme}-300`, `${theme}-glow`, `border-t-${theme}-400`);
                    });
                    el.classList.remove('bg-gradient-to-b');
                });
            };

            const applyTheme = (station) => {
                removeAllThemes();
                const theme = station ? station.theme : state.stations[0].theme;
                displayDiv.classList.add('bg-gradient-to-b', ...theme.bg.split(' '));
                mhzText.classList.add(theme.text);
                sliderPointer.classList.add(theme.pointer);
                controls.querySelectorAll('button').forEach(btn => {
                    btn.classList.add(theme.glow, `text-${theme.text.split('-')[1]}-300`);
                });
            };

            const getCurrentStation = () => {
                const freq = parseFloat(state.currentFrequency);
                return state.stations.find(station => Math.abs(station.freq - freq) < 0.1);
            };

            function pickPlayableUrl(station){
                // si el mime no es soportado, no reproducimos
                if (station.mime && !canPlay(station.mime)) return null;
                return station.url;
            }

            const playCurrentStation = () => {
                const station = getCurrentStation();
                const url = station && pickPlayableUrl(station);
                if (!url) { console.warn('Formato no soportado para esta estación'); return; }
                audioPlayer.src = url;
                audioPlayer.play().then(()=>{
                    try { if (!isAudioContextInitialized) initAudioContextSafe(); if (audioContext?.state === 'suspended') audioContext.resume(); } catch(e){}
                }).catch(e => console.error("Error al reproducir audio:", e));
            };

            const pauseStation = () => { audioPlayer.pause(); audioPlayer.src = ""; };

            const updateDisplay = () => {
                const freq = parseFloat(state.currentFrequency).toFixed(1);
                frequencyDisplay.textContent = freq;
                const currentStation = getCurrentStation();
                stationNameDisplay.textContent = currentStation ? currentStation.name : '---';
                applyTheme(currentStation);
            };

            const updatePointerPosition = () => {
                const min = parseFloat(frequencySlider.min);
                const max = parseFloat(frequencySlider.max);
                const val = parseFloat(state.currentFrequency);
                const percentage = ((val - min) * 100) / (max - min);
                document.getElementById('slider-pointer').style.left = percentage + '%';
            };

            const togglePower = () => {
                const wasPlaying = state.isPlaying;
                state.isOn = !state.isOn;
                if (!state.isOn && wasPlaying) togglePlayPause();
                document.getElementById('radio-container').classList.toggle('is-off', !state.isOn);
            };

            const togglePlayPause = () => {
                if (!state.isOn) return;
                state.isPlaying = !state.isPlaying;
                playIcon.classList.toggle('hidden', state.isPlaying);
                pauseIcon.classList.toggle('hidden', !state.isPlaying);
                document.getElementById('radio-container').classList.toggle('is-playing', state.isPlaying);
                if (state.isPlaying) playCurrentStation(); else pauseStation();
            };

            const handleSliderChange = (event) => {
                state.currentFrequency = event.target.value;
                updateDisplay();
                updatePointerPosition();
                if (state.isPlaying) {
                    clearTimeout(window.sliderTimeout);
                    window.sliderTimeout = setTimeout(playCurrentStation, 250);
                }
            };

            const scan = (direction) => {
                const currentFreq = parseFloat(state.currentFrequency);
                let list = state.stations.filter(s => direction === 'up' ? s.freq > currentFreq : s.freq < currentFreq);
                list.sort((a, b) => direction === 'up' ? a.freq - b.freq : b.freq - a.freq);
                let nextStation = list[0];
                if (!nextStation) {
                    nextStation = direction === 'up' 
                        ? [...state.stations].sort((a,b)=>a.freq-b.freq)[0]
                        : [...state.stations].sort((a,b)=>b.freq-a.freq)[0];
                }
                state.currentFrequency = nextStation.freq;
                document.getElementById('frequency-slider').value = state.currentFrequency;
                updateDisplay();
                updatePointerPosition();
                if (state.isPlaying) playCurrentStation();
            };

            document.getElementById('scan-up').addEventListener('click', () => scan('up'));
            document.getElementById('scan-down').addEventListener('click', () => scan('down'));
            document.getElementById('btn-next').addEventListener('click', () => scan('up'));
            document.getElementById('btn-prev').addEventListener('click', () => scan('down'));
            document.getElementById('power-button').addEventListener('click', togglePower);
            document.getElementById('play-pause-button').addEventListener('click', togglePlayPause);
            document.getElementById('frequency-slider').addEventListener('input', handleSliderChange);
            window.addEventListener('resize', setupCanvas);

            // Install prompt (doble tap en título)
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); state.deferredPrompt = e; });
            let lastTap = 0;
            titleInstall.addEventListener('click', async () => {
                const now = Date.now();
                if (now - lastTap < 400 && state.deferredPrompt) {
                    state.deferredPrompt.prompt();
                    await state.deferredPrompt.userChoice;
                    state.deferredPrompt = null;
                }
                lastTap = now;
            });

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            }

            const init = () => {
                document.getElementById('frequency-slider').value = state.currentFrequency;
                updateDisplay();
                updatePointerPosition();
                setupCanvas();
            };
            init();
        });
    </script>
</body>
</html>
